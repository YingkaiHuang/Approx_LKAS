#include <Eigen/Eigen>
#include "config.hpp"

using namespace std;
using namespace Eigen;

// constructor
lateralController::lateralController() {
    // initialize member variables 
    m_d   = 0.135L;   // 2*d = distance between left and right wheels
    m_l   = 0.42L;    // l = distance between front and read wheels 
    m_vx  = 2.2L;     // vehicle longitudinal speed is 2.2m/s to simulate ~80km/h in reality
    m_LL  = 0.55L;    // look-ahead distance is 0.25s*vx
    m_l_r = 0.21L;    // distance from CG to rear axle (m)

    m_z1    = 0.0L;         // z1 is vy
    m_z2    = 0.0L;         // z2 is yaw rate
    m_z3    = 0.0L;         // z3 is yL
    m_z4    = 0.0L;         // z4 is epsilon_L
    m_z5    = 0.0L;         // z5 is curvature at lookahead distance KL (which is K_ref of CoG)
    fill(m_input.begin(), m_input.end(), 0.0L); // m_input is the input of the last sampling period.

    m_desired_steering_angle = 0.0L;
    m_steering_angle_left    = 0.0L;
    m_steering_angle_right   = 0.0L;

    m_phi_aug[0] <<   
	0.00844149939133121,-0.001299990906265,0,0,0,0.791162997360674,
	0,0.00844149939133121,0,0,0,4.5259092753452,
	-0.0145371681157311,-0.00933451962887306,1,0.154,0.011858,-0.232124352362097,
	0,-0.0145371681157311,0,1,0.154,-0.289836444661472,
	0,0,0,0,1,0,
	0,0,0,0,0,0;

	// v0
    m_K2c[0] <<
    -0.0985200721762825,-0.858895549193338,-1.9981267091516,0.198340356709161,-0.629776542700465;

    m_T[0] <<
    -1.11022302462516e-16,2.77555756156289e-17,6.93889390390723e-18,0,-1,3.46944695195361e-18,
    -0.973371303352268,0.171925096346866,-0.101704004141892,0.110604531588442,0,0.0203224061084032,
    0.148488499641457,-0.0198692391189732,-0.724306314230338,0.672966591740375,0,-0.0072600536133363,
    -0.0246364091803646,-0.0799874537011583,-0.679038425917489,-0.727162874519977,0,0.0560002200035455,
    0.129379677665579,0.811900959950947,-0.0627956277658821,-0.0782076687397393,0,-0.560373089933542,
    0.114688350037763,0.551784208784638,-0.000428915559090858,-0.000564325778018716,0,0.826063113127191;


    m_Gamma_aug[0] <<
    0.138837273103253,
    0.667968584985926,
    -0.000519228558054277,
    -0.000683150922793747,
    0,
    1;

    // v1
    m_phi_aug[1] <<   
    0.181733742023934,-0.00999535581131638,0,0,0,0.763103741419374,
    0,0.181733742023934,0,0,0,4.04193541859325,
    -0.0119965429657719,-0.00677711687538046,1,0.055,0.0015125,-0.0521672080573486,
    0,-0.0119965429657719,0,1,0.055,-0.0680271887857569,
    0,0,0,0,1,0,
    0,0,0,0,0,0;


    m_K2c[1] <<
    -1.71312668741853,-0.942739856605284,-2.3157329437477,-0.00811901041367819,-0.342124678959663;


    m_T[1] <<
    1.52655665885959e-16,-2.08166817117217e-17,5.55111512312578e-17,-1.11022302462516e-16,1,-2.43945488809238e-19,
    -0.121696396680908,0.0241307942132857,-0.752713357615527,0.646552536887202,1.11022302462516e-16,0.000331839421484977,
    0.934144412347705,-0.182059360826482,-0.274630106422577,-0.137098538595887,0,-0.00330172321827868,
    -0.279768552922366,0.0316920537784086,-0.598179663956464,-0.750243044524365,0,0.00645246424054755,
    0.17842532137893,0.953477456319889,-0.0134904227521533,-0.0175833703914515,0,-0.241979293660068,
    0.0495798890780861,0.236956637221138,-6.35325319702658e-05,-8.35947649852129e-05,0,0.970254284015993;


    m_Gamma_aug[1] <<
    0.05109989195087,
    0.244221170805191,
    -6.54802900815829e-05,
    -8.61575840090132e-05,
    0,
    1;


    // v2
    m_phi_aug[2] <<   
    0.0166972659996382,-0.00220403911195224,0,0,0,0.76297641236487,
    0,0.0166972659996382,0,0,0,4.35966178155734,
    -0.01441613091315,-0.00896647080818548,1,0.132,0.008712,-0.188332536790799,
    0,-0.01441613091315,0,1,0.132,-0.237797596777301,
    0,0,0,0,1,0,
    0,0,0,0,0,0;


    m_K2c[2] <<
    -0.315204782003307,-1.16139878628945,-2.30564187402571,0.226912220774633,-0.591052963326404;


    m_T[2] <<
    -3.33066907387547e-16,6.93889390390723e-17,1.38777878078145e-17,-1.38777878078145e-17,-1,6.93889390390723e-18,
    -0.93462501645778,0.166292089160426,-0.217874459939422,0.22555559052577,2.77555756156289e-16,0.0218726994820431,
    0.308590750759119,-0.0501001438668115,-0.71023975841042,0.630636243752695,0,-0.0109150249220121,
    -0.0334329948083597,-0.066746024652609,-0.66698035859168,-0.73912653071612,0,0.0570646641599107,
    0.117644492585346,0.76602566260549,-0.056807342604857,-0.0715122362598947,0,-0.625318625570549,
    0.127631639414758,0.615293888389994,-0.00057650524827608,-0.000758488447071765,0,0.777896322055322;


    m_Gamma_aug[2] <<
    0.164072815098978,
    0.790971587015983,
    -0.000741108078198473,
    -0.000975050820484305,
    0,
    1;


    // v3
    m_phi_aug[3] <<   
    0.00844149939133121,-0.001299990906265,0,0,0,0.900455991073069,
    0,0.00844149939133121,0,0,0,5.05289676984718,
    -0.0145371681157311,-0.00933451962887306,1,0.154,0.011858,-0.232622054295797,
    0,-0.0145371681157311,0,1,0.154,-0.290491271152968,
    0,0,0,0,1,0,
    0,0,0,0,0,0;


    m_K2c[3] <<
    -0.098652549128349,-0.864287002834973,-1.97736336440827,-0.0634044157251221,-0.756366796563265;

    m_T[3] <<
    3.33066907387547e-16,-6.93889390390723e-17,-6.93889390390723e-18,6.93889390390723e-18,-1,-1.0842021724855e-18,
    -0.970372531114511,0.174749883838773,-0.113102147838357,0.122602053233744,-3.88578058618805e-16,0.00403356591291155,
    0.16461282839195,-0.0241471319581009,-0.723925461818811,0.669514256322761,0,-0.00145569845873907,
    -0.0255585847072086,-0.069214126066751,-0.678987312285668,-0.73035786521063,0,0.0104776896612195,
    0.172543920252532,0.971914162555647,-0.0460006433202924,-0.057417637207192,0,-0.142121820841507,
    0.029242467728845,0.139540888248228,-2.13067176104819e-05,-2.80350810797759e-05,0,0.989784429736133;

    m_Gamma_aug[3] <<
    0.0295442793908575,
    0.140981090483943,
    -2.15266243541152e-05,
    -2.83244312978835e-05,
    0,
    1;


    // v4
    m_phi_aug[4] <<   
    0.181733742023934,-0.00999535581131638,0,0,0,0.509263457543366,
    0,0.181733742023934,0,0,0,2.7979879073952,
    -0.0119965429657719,-0.00677711687538046,1,0.055,0.0015125,-0.0493065226755558,
    0,-0.0119965429657719,0,1,0.055,-0.0642646140978598,
    0,0,0,0,1,0,
    0,0,0,0,0,0;

    m_K2c[4] <<
    -1.7042549276122,-0.846770987405968,-2.35455669891164,0.0741276517229247,-0.193662351490058;

    m_T[4] <<
    -9.71445146547012e-17,1.04083408558608e-17,5.55111512312578e-17,0,1,2.16840434497101e-18,
    -0.163922544710455,0.0314216460566803,-0.744517779254599,0.646392186804575,-1.66533453693773e-16,0.00353506810936127,
    0.94572695599072,-0.176778222797274,-0.265336569576794,-0.0570460992571831,0,-0.0263103033415218,
    -0.2150986257953,0.0040740225199672,-0.611543315240891,-0.759424680114796,0,0.0548170807157857,
    0.0659500363134091,0.546071819986748,-0.0360827677701536,-0.0468247831094698,0,-0.83304359650826,
    0.167669609468767,0.818261027949269,-0.00160893543828289,-0.00211620340032433,0,0.549844273599281;

    m_Gamma_aug[4] <<
    0.304940175826878,
    1.48816868200324,
    -0.00292616567187432,
    -0.00384873227190612,
    0,
    1;


    // v5
    m_phi_aug[5] <<   
    0.0166972659996382,-0.00220403911195224,0,0,0,0.62722488277678,
    0,0.0166972659996382,0,0,0,3.6881298043668,
    -0.01441613091315,-0.00896647080818548,1,0.132,0.008712,-0.186259692495296,
    0,-0.01441613091315,0,1,0.132,-0.235071450397005,
    0,0,0,0,1,0,
    0,0,0,0,0,0;


    m_K2c[5] <<
    -0.284595288872105,-1.16222984606672,-2.3229906829086,0.216517484966073,-0.421515514233299;


    m_T[5] <<
    -3.33066907387547e-16,5.55111512312578e-17,-1.38777878078145e-17,6.93889390390723e-17,-1,1.73472347597681e-17,
    -0.947625120960637,0.163754390854818,-0.187450769984062,0.195049058124279,2.77555756156289e-16,0.0448241381101813,
    0.266203356396145,-0.0400717692179349,-0.716808868932755,0.642868946015742,0,-0.0208468228544425,
    -0.0274505950909358,-0.0835856681880117,-0.664818911589243,-0.731044021987944,0,0.125898187483784,
    0.0504742625733851,0.549681297435418,-0.0951872715450824,-0.119355680312303,0,-0.819753880735175,
    0.166856875239208,0.813905805428854,-0.0015660079258671,-0.00205977336567161,0,0.556515433772931;


    m_Gamma_aug[5] <<
    0.299824344687067,
    1.46250356420653,
    -0.00281395237370193,
    -0.00370119720078066,
    0,
    1;

    // v6
    m_phi_aug[6] <<   
    0.181733742023934,-0.00999535581131638,0,0,0,0.675366360266991,
    0,0.181733742023934,0,0,0,3.61818800441251,
    -0.0119965429657719,-0.00677711687538046,1,0.055,0.0015125,-0.0517134597893759,
    0,-0.0119965429657719,0,1,0.055,-0.0674301954469722,
    0,0,0,0,1,0,
    0,0,0,0,0,0;


    m_K2c[6] <<
    -1.71075557973942,-0.906424642482038,-2.33062093279039,0.0786036545720179,-0.291206374847748;


    m_T[6] <<
    -1.11022302462516e-16,1.21430643318376e-17,-2.22044604925031e-16,2.77555756156289e-16,1,7.58941520739853e-19,
    -0.13360018650419,0.0262248420423229,-0.750448183762349,0.646753119328661,-2.77555756156289e-16,0.00108349081177754,
    0.939103464714758,-0.180755453772343,-0.269851848617477,-0.111780620703693,0,-0.00986007733844244,
    -0.258381171155779,0.0231667571980117,-0.60305244506755,-0.754087021231456,0,0.0195699939043201,
    0.142553237369649,0.813410850608872,-0.018304857689003,-0.0238315215718499,0,-0.563150382572666,
    0.114688350037763,0.551784208784638,-0.000428915559090858,-0.000564325778018716,0,0.826063113127191;


    m_Gamma_aug[6] <<
    0.138837273103253,
    0.667968584985926,
    -0.000519228558054277,
    -0.000683150922793747,
    0,
    1;



    // v7
    m_phi_aug[7] <<   
    0.255592705610489,-0.0112460790468615,0,0,0,0.7152024978638,
    0,0.255592705610489,0,0,0,3.72364685995234,
    -0.0109137019938552,-0.00610847288997768,1,0.044,0.000968,-0.0363532874347732,
    0,-0.0109137019938552,0,1,0.044,-0.0475507373904542,
    0,0,0,0,1,0,
    0,0,0,0,0,0;


    m_K2c[7] <<
    -1.85324124205566,-1.13574379568676,-2.25465977959021,-0.0300159070715164,-0.283191513321802;


    m_T[7] <<
    5.55111512312578e-17,-1.21430643318376e-17,3.33066907387547e-16,-2.77555756156289e-16,1,-8.13151629364128e-20,
    -0.0719731835044512,0.0145253638856264,-0.764839549255813,0.640022912658682,4.44089209850063e-16,9.9127627203056e-05,
    0.901693506090672,-0.17925812316431,-0.300650036452502,-0.253814862222724,0,-0.00170811284448,
    -0.382496629217695,0.0580948576755937,-0.569675052093892,-0.725104880179674,0,0.00381626914614068,
    0.184808018678071,0.966642147379815,-0.0100176547152966,-0.0130995357691218,0,-0.176570110431704,
    0.0362078278764808,0.172868405164714,-3.30318212712146e-05,-4.34627443510191e-05,0,0.984279180271616;


    m_Gamma_aug[7] <<
    0.036786136090463,
    0.17562944399272,
    -3.35594025895167e-05,
    -4.41569274471755e-05,
    0,
    1;


    // controller design time parameters
    // Eigen::Matrix<typename Scalar, int RowsAtCompileTime, int ColsAtCompileTime>
    // m_phi_aug[0] <<   
    // 0.0918776327042182, -0.00707457771822480,   0.0, 0.0,               0.0,                    0.363958059622097,
    // 0.0,                 0.0918776327042182,    0.0, 0.0,               0.0,                    2.16691692168894,
    // -0.0133139169448205, -0.00769641039671197,  1.0, 0.0770000000000000, 0.00296450000000000,   -0.0767989027685686,
    // 0.0,                -0.0133139169448205,    0.0, 1.0,               0.0770000000000000,     -0.0991833672592122,
    // 0.0,                0.0,                    0.0, 0.0,               1.0,                    0.0,
    // 0.0,                0.0,                    0.0, 0.0,               0.0,                    0.0;

    // m_phi_aug[1] << 
    // 0.0118722348685005,     -0.00169772958619558,   0.0,    0.0,                0.0,                0.270386077553564,
    // 0.0,                    0.0118722348685005,     0.0,    0.0,                0.0,                1.82074451777197,
    // -0.0144868703487697,    -0.00915466147626915,   1.0,    0.143000000000000,  0.0102245000000000, -0.188276526171552,
    // 0.0,                    -0.0144868703487697,    0.0,    1.0,                0.143000000000000,  -0.235210957016398,
    // 0.0,                    0.0,                    0.0,    0.0,                1.0,                0.0,
    // 0.0,                    0.0,                    0.0,    0.0,                0.0,                0.0;

    // m_phi_aug[2] << 
    // 0.00109079283462631,    -0.000239974423617788,  0.0,    0.0,                0.0,                0.117088047013593,
    // 0.0,                    0.00109079283462631,    0.0,    0.0,                0.0,                0.946224971943994,
    // -0.0146449362977584,    -0.0103389206542932,    1.0,    0.220000000000000,  0.0242000000000000, -0.318795200098652,
    // 0.0,                    -0.0146449362977584,    0.0,    1.0,                0.220000000000000,  -0.378984606356262,
    // 0.0,                    0.0,                    0.0,    0.0,                1.0,                0.0,
    // 0.0,                    0.0,                    0.0,    0.0,                0.0,                0.0;

    // m_K2c[0] <<
    // -1.27004708426265,  -0.993342577905539, -2.32887772320683,  -0.150176674250064, -0.166927235573133;

    // m_K2c[1] <<
    // -0.153270652618691, -1.07750431014129,  -2.14512271372622,  -0.771497202846323, -0.224084637449841;

    // m_K2c[2] <<
    // -0.173715537382887, -0.299547670057026, -1.33074434011709,  -1.37473579955885,  -0.216185759620623;

    // m_T[0] <<
    // 2.22044604925031e-16,   -3.12250225675825e-17,  -1.38777878078145e-16,  1.11022302462516e-16,   1.0,                    -1.21430643318377e-17,
    // -0.510973128132855,     0.0891254407736498,     -0.626903568075381,     0.580244756611668,      1.11022302462516e-16,   0.0356518848316525,
    // 0.836156661627320,      -0.140352107965776,     -0.440887574357094,     0.285904466369721,      0.0,                    -0.0708527056165297,
    // -0.0722758744389881,    -0.0645178137794465,    -0.630850966556284,     -0.746800023526678,     0.0,                    0.186896849986180,
    // -0.0284319278135091,    0.356811173865362,      -0.120921617476409,     -0.154396732132324,     0.0,                    -0.912916766862882,
    // 0.183620050640630,      0.916995735816917,      -0.00388375253662170,   -0.00510220559411356,   0.0,                    0.354064092306228;

    // m_T[1] <<
    // 3.71924713249427e-15,   -5.55111512312578e-16,  -2.08166817117217e-17,  -1.38777878078145e-17,  -1.00000000000000,      -6.24500451351651e-16,
    // -0.972933723419078,     0.145422523010875,      -0.0631815252031047,    0.0688317334136003,     -3.88578058618805e-15,  0.153370619687505,
    // 0.0857476107462564,     0.00315693917286961,    -0.723128932830526,     0.682441625223447,      0.0,                    -0.0632088257455602,
    // 0.0565048683688237,     -0.183732624599507,     -0.579944614260062,     -0.569874738473237,     0.0,                    0.549505731862013,
    // -0.0932172401608718,    0.241135628719415,      -0.369753064750303,     -0.452449318738079,     0.0,                    -0.769244070357445,
    // 0.184837937319724,      0.941773993459195,      -0.00628942564160199,   -0.00824724567156644,   0.0,                    0.280693976129240;

    // m_T[2] <<
    // -1.59872115546023e-14,  1.94982918699793e-15,   -3.04660810468427e-17,  1.62630325872826e-17,   -1.0,                   4.52415882534751e-15,
    // -0.954953348005701,     0.117885721520670,      -0.00189103090089187,   0.00246017898743884,    1.68198788230711e-14,   0.272318620949313,
    // -0.0677585743984616,    0.0823799227075405,     -0.647118786524705,     0.699395766707389,      0.0,                    -0.284086538872868,
    // 0.210101249002934,      -0.241166547525313,     -0.441162497672326,     -0.0189263251233561,    0.0,                    0.838280147914150,
    // -0.0790727051595015,    0.0670619513235785,     -0.621669703386502,     -0.714317724424600,     0.0,                    -0.304182791176016,
    // 0.181873173377374,      0.957422527432714,      -0.0116675047794324,    -0.0152148552842289,    0.0,                    0.223375536442332;

    // m_Gamma_aug[0] <<
    // 0.518606813372700,
    // 2.58991452605088,
    // -0.0109690663950827,
    // -0.0144104011250615,
    // 0.0,
    // 1.0;

    // m_Gamma_aug[1] <<
    // 0.658503398856764,
    // 3.35516282339303,
    // -0.0224066997387438,
    // -0.0293816268709991,
    // 0.0,
    // 1.0;

    // m_Gamma_aug[2] <<
    // 0.814203633370244,
    // 4.28615658939844,
    // -0.0522326883474302,
    // -0.0681133463697660,
    // 0.0,
    // 1.0;
}
// destructor
lateralController::~lateralController(){}

// class methods
void lateralController::compute_steering_angles(long double the_yL, int the_it_counter, int the_pipe_version) {
    m_z3 = the_yL;
    m_z5 = 2 * m_z3 / ( pow( m_LL + m_l_r, 2 ) );   // curvature calculate

    Matrix<long double, 6, 1> zt_temp, zt;       // zt is the transferred state vector
    if (the_it_counter == 0){
        zt_temp <<  m_z1,
                    m_z2,
                    m_z3,
                    m_z4,
                    m_z5,
                    0.0L;
    } else {
        zt_temp <<  m_z1,
                    m_z2,
                    m_z3,
                    m_z4,
                    m_z5,
                    m_input[the_it_counter-1];
    }

    zt = m_T[the_pipe_version] * zt_temp;        

    Matrix<long double, 5, 1> zt_temp_2;
    zt_temp_2 << zt[1], 
                 zt[2], 
                 zt[3], 
                 zt[4], 
                 zt[5];

    // calculate the desired steering angle *** |TODO| replace SELECT_PERIOD with variable **********|TODO|
    m_desired_steering_angle = m_K2c[the_pipe_version] * zt_temp_2;   
    // calculate left front tire steering angle according to desired steering angle                     
    m_steering_angle_left    = atan( m_l / (-m_d + m_l / tan(m_desired_steering_angle) ) );  
    // calculate right front tire steering angle according to desired steering angle 
    m_steering_angle_right   = atan( m_l / ( m_d + m_l / tan(m_desired_steering_angle) ) );         
}

vector<long double> lateralController::get_steering_angles() {
    // return steering angles
    vector<long double> steering_angles(2);
    steering_angles[0] = m_steering_angle_left;
    steering_angles[1] = m_steering_angle_right;
    return steering_angles;     
}

void lateralController::estimate_next_state(int the_it_counter, int the_pipe_version) {
    // transfer state vector
    Matrix<long double, 6, 1> zkp_temp, zkp;  
    if (the_it_counter == 0){
        zkp_temp << m_z1,
                    m_z2,
                    m_z3,
                    m_z4,
                    m_z5,
                    0.0L;       
    } else {
        zkp_temp << m_z1,
                    m_z2,
                    m_z3,
                    m_z4,
                    m_z5,
                    m_input[the_it_counter-1]; 
    }

    // given the control design, estimate next states
    zkp = m_phi_aug[the_pipe_version]   * zkp_temp + 
          m_Gamma_aug[the_pipe_version] * m_desired_steering_angle;  

        m_z1 = zkp[0];
        m_z2 = zkp[1];
        m_z4 = zkp[3];
        m_z5 = zkp[4];
        m_input[the_it_counter+1] = m_desired_steering_angle;
}

